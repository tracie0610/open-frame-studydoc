/* Copyright (C) 2008 Microsoft Corporation */registerNamespace("Live.Controls");Live.Controls.EnhancedPreviewItem=function(e,c){Live.Controls.EnhancedPreviewItem.initializeBase(this,arguments);c=this.getParameters();var d=this,b=null,a=null,ib=c.headtemplatetype||"Live.Controls.HeadTemplate",hb=c.bodytemplatetype||"Live.Controls.BodyTemplate",ab=c.minimumvisibleactioncount||3,Z=c.maximumvisibleactioncountbeforehiding||5,i=1,x=1,J=1,T=0,F=64,I=16,f=null,Q=Number(c.showdotsdelay)||0,S=Number(c.showepdelay)||750,ob=Number(c.hideepdelay)||250,gb=4000,N=0,E=0,A=0,z=1,l=0,t=$Browser._isIE&&7<=$Browser.version,D=$Browser.isMozilla(),xb=$Browser._isIE,B="attachtobody" in c?"true"===c.attachtobody.toLowerCase():false,db="actionlinksmaywrap" in c?"true"===c.actionlinksmaywrap.toLowerCase():false,q=false,qb=10000,M="_zIndex",nb=this.dotsImagePath=$Config.Themes.url+"controls/img/",m,C=0,g={};if(t){this.dotsImagePath+="ep_dots_collage_ie7.gif";this.spacerImagePath=nb+"spacer.gif"}else this.dotsImagePath+="ep_dots_collage.gif";this.initialize=function(){Live.Controls.EnhancedPreviewItem.callBaseMethod(this,"initialize",arguments);if(!e||e===document.body.parentNode)return;b=new $Memory.Groups;a={showEpTimeoutId:0,hideEpTimeoutId:0,loadErrorTimeoutId:0,dotsVisible:1};a.dialogStrings=Live.Controls.Strings.Dialog;a.strings=Live.Controls.Strings.LiveEnhancedPreviewStrings;b.create(null).Events.register(e,{onmouseenter:W});b.create(null).Events.register(e,{onmousemove:G});b.create(null).Events.register(e,{onmouseleave:H});a.dots=new Live.Controls.DotsTemplate;a.dots.dotsAlt=a.strings.DotsAlt;var d={className:"uxp_ep_dots",innerHTML:a.dots.toString()},c=b.create("init").Nodes.create("div",d,{},null);e.insertAdjacentElement("afterend",c);c=a.dots.getElement("parent").parentNode;a.eDots=a.dots.getElement("dots");b.create(null).Events.register(a.eDots,{onfocus:mb});a.eGhost=a.dots.getElement("ghost")};function G(){g.offsetX=event.x;g.clientX=event.clientX;g.clientY=event.clientY}this.dispose=function(){Live.Controls.EnhancedPreviewItem.callBaseMethod(this,"dispose",arguments);document.body.detachEvent("onkeypress",w);if(b){j();n();k();v();if(f){f._visibleEp=null;f=null}b.dispose();a=null;b=null}};d.getBoundElement=kb;function kb(){return e}function j(){o("showDotsTimeoutId")}function n(){o("showEpTimeoutId")}function k(){o("hideEpTimeoutId")}function v(){o("loadErrorTimeoutId")}function o(b){if(a[b]){clearTimeout(a[b]);a[b]=0}}function s(){var c=a.template.getElement("ep");if(c){a.anchors=c.getElementsByTagName("a");for(var b=0;b<a.anchors.length;b++)tb(a.anchors[b],b)}}function tb(a){b.create("watchBlur").Events.register(a,{onblur:vb})}function vb(b){var c=a.template.getElement("ep");if(!q)if(b.explicitOriginalTarget){if(!y(c,b.explicitOriginalTarget))if(D&&B){p();a.eDots.focus()}else h()}else if(event.shiftKey){if(event.srcElement==a.anchors[0])h()}else if(event.srcElement==a.anchors[a.anchors.length-1]||"none"===a.anchors[pb(a.anchors,event.srcElement)+1].parentNode.style.display)h()}function pb(b,c){var a=b.length;while(a--)if(c===b[a])return a;return -1}d.abort=function(){C=1};function W(){j();g.type=event.type;G();if(Q)a.showDotsTimeoutId=setTimeout(L,Q);else L()}function L(){n();if(!X())if(S)a.showEpTimeoutId=setTimeout(u,S);else u()}d.show=function(b){g.type="focus";a.dotsVisible=b;U();if(i)u();a.dotsVisible=1};function mb(){g.type=event.type;U()}function U(){j();if(!X()){var c=a.eDots;b.create("showByKeyboard").Events.register(c,{onclick:wb});b.create("showByKeyboard").Events.register(c,{onblur:ub})}}function X(){k();if(!i)return 1;Ab();d.fire("onbeforedots",m);if(C){C=0;return 1}a.position=rb();sb();if(!a.dotsPopup){a.dotsPopup=new Web.UI.Popup;b.create(null).Properties.register(a.dotsPopup);a.dotsPopup.autoCalc=false;a.dotsPopup.setContents(a.eDots,null,{hidden:0});a.dotsPopup.dockTo(e,null,true)}a.dotsPopup.setDock(Web.UI.Popup.VDock.Top,a.position.dotsDockSide);a.dotsPopup.setAnchor(Web.UI.Popup.VAnchor.Bottom,a.position.anchorSide);a.dotsPopup.setPadding(a.position.beakOffsetTop,a.position.beakOffsetLeft);a.eDots.className=a.position.dotsClass;window.e=g;a.dotsPopup.recalc(true);a.dotsVisible?a.dotsPopup.show():a.dotsPopup.hide();if(a.eDots.firstChild)a.eDots.firstChild.src=d.dotsImagePath}function w(){var c=event.keyCode,b=27;if(b===c){p();a.eDots.focus()}}function ub(b){if(i)Y();else if(event.shiftKey)h();else if(b.explicitOriginalTarget)if(!q&&!y(a.eDotsParent,b.explicitOriginalTarget))h()}function Ab(){if(!a.eDotsParent){f=Live.Controls.EnhancedPreviewController.__Instance;if(!f){f=Live.Controls.EnhancedPreviewController.__Instance=new Live.Controls.EnhancedPreviewController(document.body);f.initialize()}var h=Function.parse(ib),g=Function.parse(hb);a.template=new Live.Controls.EnhancedPreviewTemplate(new h,new g,a.dialogStrings.Close,ab,Z);b.create(null).Properties.register(a.template);a.template.loading.text=a.strings.Loading;a.template.loadError.text=a.strings.LoadError;a.template.actions.moreActionsText=a.strings.More;a.template.actions.actionLinksMayWrap=db;a.template.actions.clear()}m={template:a.template,srcObject:d,srcElement:e,bindingParams:c};f.fire("onbeforeopen",m)}function zb(){if(!a.eDotsParent){a.eDotsParent=a.dots.getElement("parent");a.template.setParent(a.eDotsParent);a.template.render();a.template.head.render();a.template.body.render();a.template.actions.render();a.eClose=a.template.getElement("closeAnchor");b.create(null).Events.register(a.eClose,{onclick:lb});b.create(null).Events.register(a.eClose,{onkeypress:bb});var d=a.template.getElement("beak"),c=a.template.getElement("ep");if(D&&B){if(c.parentNode){c.parentNode.removeChild(c);d.parentNode.removeChild(d)}b.create(null).Events.register(c,{onmouseenter:W});b.create(null).Events.register(c,{onmouseleave:H})}a.beakPopup=new Web.UI.Popup;b.create(null).Properties.register(a.beakPopup);a.beakPopup.autoCalc=false;a.beakPopup.setContents(d);a.beakPopup.dockTo(a.eDots,null,true);a.epPopup=new Web.UI.Popup;a.epPopup.shadow=true;b.create(null).Properties.register(a.epPopup);a.epPopup.autoCalc=false;a.epPopup.setContents(c);a.epPopup.dockTo(d,null,true)}}function sb(){if(f._visibleEp)f._visibleEp.hideRegardless();f._visibleEp=d}function wb(){i?u():p()}function u(){document.body.attachEvent("onkeypress",w);zb();var f=a.template.getElement("beak"),c=f.className.replace(" uxp_ep_beakRight","");if(a.position.isRight)c+=" uxp_ep_beakRight";f.className=c;n();i=0;b.create("showByMouse").Events.register(a.eDotsParent,{onmouseleave:V});b.create("showByMouse").Events.register(a.eDotsParent,{onmouseenter:k});if(E){eb();s();return}else if(N){K();s();return}if(x){r();v();a.loadErrorTimeoutId=setTimeout(K,gb)}else if(J)R();else r();s();var e=a.template.getElement("ep").firstChild;e.style.paddingLeft="1px";e.style.paddingLeft="";d.fire("onshow",m);O(true)}function r(){if(i)return;a.beakPopup.setDock(Web.UI.Popup.VDock.Middle,a.position.dockSide);a.beakPopup.setAnchor(Web.UI.Popup.VAnchor.Middle,a.position.anchorSide);a.epPopup.setDock(Web.UI.Popup.VDock.Bottom,a.position.dockSide);a.epPopup.setAnchor(Web.UI.Popup.VAnchor.Bottom,a.position.anchorSide);a.epPopup.setPadding(a.position.epPaddingBottom,a.position.epPaddingLeft);a.epPopup.setRelocateStyle({top:0,right:3,bottom:3,left:0,enableX:false,enableY:true});a.beakPopup.show();a.epPopup.show();a.beakPopup.recalc(true);a.epPopup.recalc(true);if(D&&B){var b=a.template.getElement("closeAnchor");q=true;b.focus();q=false}}function rb(){var k=Web.UI.Utilities.isRightToLeftMarket(),c=Web.UI.getLayoutRoot(),l=Web.UI.getLocation(e),f="focus"===g.type,d=f?{x:l.right-e.scrollLeft,y:l.top-e.scrollTop}:Web.UI.getMouseLocation(g,c),j=a.epPopup?a.epPopup.getBounds().width+32:a.eGhost.offsetWidth+32,m={dotsDockSide:f?k?Web.UI.Popup.HDock.Left:Web.UI.Popup.HDock.Right:Web.UI.Popup.HDock.Cursor,epPaddingBottom:F},h={dockSide:Web.UI.Popup.HDock.Right,anchorSide:Web.UI.Popup.HAnchor.Left,dotsClass:"uxp_ep_dotsA uxp_ep_show",isRight:0,epPaddingLeft:-1,beakOffsetLeft:0,beakOffsetTop:0},i={dockSide:Web.UI.Popup.HDock.Left,anchorSide:Web.UI.Popup.HAnchor.Right,dotsClass:"uxp_ep_dotsA uxp_ep_show uxp_ep_right",isRight:1,epPaddingLeft:1,beakOffsetLeft:0,beakOffsetTop:0},b;if(k&&$Browser._isIE){if(!f)d.x=g.offsetX;var n=d.x+j>c.clientWidth;if(n){b=i;b.epPaddingLeft=t?1:0}else{b=h;b.epPaddingLeft=t?-1:-2}}else if(d.x+j>c.scrollLeft+c.clientWidth&&d.x-j>=c.scrollLeft)b=i;else b=h;if(k)b.dotsClass=b.isRight?h.dotsClass:i.dotsClass;yb(b,m);if(fb())b.epPaddingBottom=I;return b}function fb(){return x}function H(){j();if(a.eDotsParent&&y(a.eDotsParent,event.toElement))return;i?h():V()}function V(){j();k();a.hideEpTimeoutId=setTimeout(h,ob)}function lb(){if(A){p();a.eDots.focus();A=0}else d.hideRegardless();event.returnValue=false}function bb(){A=1}function p(){z=0;h();z=1}this.hideRegardless=function(){var a=l;l=0;h();l=a};this.hide=h;function h(){document.body.detachEvent("onkeypress",w);k();if(!i){d.fire("onhide",m);i=1}n();if(z)Y();if(!a.eDotsParent)return;if(!l){a.beakPopup&&a.beakPopup.hide();a.epPopup&&a.epPopup.hide()}b.disposeGroup("watchBlur");b.disposeGroup("showByMouse");O(false)}this.test_disableHide=function(a){l=a};function Y(){a.eDots.className="uxp_ep_dotsA";if(t&&a.eDots.firstChild)a.eDots.firstChild.src=d.spacerImagePath;b.disposeGroup("showByKeyboard")}this.invalidate=function(c){if(T)return;b.disposeGroup("watchBlur");var d=c.length;while(d--)a.template.invalidateElement(c[d]);s();R()};function R(){x=0;v();if(a.eDotsParent){a.eDotsParent.className=a.eDotsParent.className.replace(" uxp_ep_loadingParent","");J=0;a.template.getElement("loading").style.visibility="hidden";a.template.getElement("loadError").style.visibility="hidden";a.position.epPaddingBottom=F;r()}}d.test_showLoadingMessage=cb;d.showErrorMessage=jb;function cb(){E=1}function jb(){N=1}function eb(){P("uxp_ep_loadingParent");a.template.getElement("loadError").style.visibility="hidden"}function K(){P("uxp_ep_loadErrorParent");a.template.getElement("loading").style.visibility="hidden"}function P(b){a.eDotsParent.className=a.eDotsParent.className.replace(" uxp_ep_loadingParent","");a.eDotsParent.className+=" "+b;a.position.epPaddingBottom=I;r();T=1}function O(d){if(xb){var b=a.template.getElement("ep");if(b)while(b=b.offsetParent)if("relative"==b.currentStyle.position){var c=b.getAttribute(M);if(d){if(null==c)b.setAttribute(M,b.currentStyle.zIndex);b.style.zIndex=qb}else if(null!=c)b.style.zIndex=c}}}function yb(c,b){var a;for(a in b)c[a]=b[a]}function y(b,a){if($Browser._isIE)return b.contains(a);try{while(a&&a!==b)a=a.parentNode;return a===b}catch(c){}}};Live.Controls.EnhancedPreviewItem.Params=new $Enum("showdotsdelay","showepdelay","hideepdelay","bodytemplatetype");Live.Controls.EnhancedPreviewItem.registerClass("Live.Controls.EnhancedPreviewItem","$Binding");Live.Controls.EnhancedPreviewItem.Events=new $Enum("onbeforedots","onbeforeshow","onshow","onhide");Live.Controls.EnhancedPreviewItem.skipClass=true;Live.Controls.EnhancedPreviewController=function(){Live.Controls.EnhancedPreviewController.initializeBase(this,arguments)};Live.Controls.EnhancedPreviewController.registerClass("Live.Controls.EnhancedPreviewController","$Binding");Live.Controls.EnhancedPreviewController.Events=new $Enum("onbeforeopen");Live.Controls.Template=function(){var a=this,b=null;this.id=new Live.Controls.UniqueElementId;this.beforeToString=function(){};this.toString=function(b){if(!b)b=a.constructor.__template;return b.replace(Live.Controls.Template.__reTemplate,d)};function d(d,c){if(!c)return d;var b=a[c];if("link"===c)b=b.encodeHtml();return b instanceof Array?b.join(""):b.toString()}this.getElement=function(a){var b=a?"_"+a:"";return document.getElementById(this.id.toString()+b)};this.getParent=function(){return b};this.setParent=function(a){b=a};this.render=function(){if(b)try{a.beforeToString();b.innerHTML=a.toString()}catch(e){var d=document.createElement("span");d.innerHTML=a.toString();c(b);b.appendChild(d)}};function c(a){while(a.hasChildNodes())a.removeChild(a.lastChild)}this.dispose=function(b){var c,a;if(this==window)return;for(c in this){a=this[c];if(a)try{if(a instanceof Array)e(a,b);else if(a.dispose)a.dispose(b)}catch(d){}}};function e(a,c){var b=a.length;while(b--)if("dispose" in a[b])a[b].dispose(c)}this.invalidateElement=function(b){var c=a.getElement(b);a[b].setParent(c);a[b].render()}};Live.Controls.Template.__reTemplate=/\{([^{}]+)\}|\{\{|\}\}/g;Live.Controls.Template.registerClass("Live.Controls.Template","$Binding");Live.Controls.DotsTemplate=function(){Live.Controls.Template.call(this,arguments);this.imagePath=$Config.Themes.url+"controls/img/";this.dotsAlt=""};Live.Controls.DotsTemplate.__template='<a id="{id}_dots" class="uxp_ep_dotsA" href="#" onclick="return false"><img src="{imagePath}'+($Browser._isIE&&$Browser.version>=7?"spacer.gif":"ep_dots_collage.gif")+'" class="uxp_ep_dotsI" alt="{dotsAlt}" /></a>'+'<div id="{id}_parent" class="uxp_ep_parent uxp_ep_loadingParent"><div id="{id}_ghost" class="uxp_ep_ep uxp_ep_ghost" style="display:block">&nbsp;</div></div>';Live.Controls.EnhancedPreviewTemplate=function(d,c,e,b,a){Live.Controls.Template.call(this);this.higThemeUrl=$Config.Themes.url;this.closeText=e;this.loading=new Live.Controls.LoadingTemplate;this.loading.text="Loading...";this.loading.className="uxp_ep_loadingTemplate";this.loadError=new Live.Controls.LoadingTemplate;this.loadError.text="This data is not available right now. Please try again later.";this.loadError.className="uxp_ep_loadErrorTemplate";this.head=d;this.body=c;this.actions=new Live.Controls.ActionsTemplate(b,a)};Live.Controls.EnhancedPreviewTemplate.__template='<div id="{id}_beak" class="uxp_ep_beak"></div>'+'<div id="{id}_ep" class="uxp_ep_ep">'+'<div class="uxp_ep_border1">'+'<a id="{id}_closeAnchor" class="uxp_ep_close" href="#" onclick="return false"><img src="{higThemeUrl}hig/img/glyph/close_rest_dark.gif" alt="{closeText}" /></a>'+'<div id="{id}_loading" class="uxp_ep_loading">{loading}</div>'+'<div id="{id}_loadError" class="uxp_ep_loadError">{loadError}</div>'+'<div id="{id}_head" class="uxp_ep_head">{head}</div>'+'<div class="uxp_ep_sectionSeparator">&nbsp;</div>'+'<div id="{id}_body" class="uxp_ep_body">{body}</div>'+'<div class="uxp_ep_sectionSeparator">&nbsp;</div>'+'<div id="{id}_actions">{actions}</div>'+"</div>"+"</div>";Live.Controls.LoadingTemplate=function(){Live.Controls.Template.call(this);this.text=this.className=""};Live.Controls.LoadingTemplate.__template='<div class="{className}">'+'<span class="uxp_ep_loadingImageCollage">&nbsp;</span>'+'<div class="uxp_ep_loadingText">{text}</div>'+"</div>";Live.Controls.HeadTemplate=function(){Live.Controls.Template.call(this);this.closeText=this.title=this.subtitle=""};Live.Controls.HeadTemplate.__template="<h2>{title}</h2>"+"{subtitle}";Live.Controls.HtmlHeadTemplate=function(){Live.Controls.Template.call(this);this.html=""};Live.Controls.HtmlHeadTemplate.__template="{html}";Live.Controls.BodyTemplate=function(){Live.Controls.Template.call(this);this.body=""};Live.Controls.BodyTemplate.__template="{body}";Live.Controls.NewsBodyTemplate=function(){Live.Controls.Template.call(this);this.image=this.imageTitle=this.imageAlt=this.link=this.linkText=this.body="";this.linkLabel="Page source:"};Live.Controls.NewsBodyTemplate.__template='<img src="{image}" title="{imageTitle}" alt="{imageAlt}" />'+"<br />"+"{linkLabel}"+"<br />"+'<a href="{link}">{linkText}</a>'+"<br />"+"{body}";Live.Controls.ImageBodyTemplate=function(){Live.Controls.Template.call(this);this.image=this.imageTitle=this.imageAlt=this.link=this.linkText="";this.linkLabel="Page source:"};Live.Controls.ImageBodyTemplate.__template='<img src="{image}" title="{imageTitle}" alt="{imageAlt}" />'+"<br />"+"{linkLabel}"+"<br />"+'<a href="{link}">{linkText}</a>';Live.Controls.ActionsTemplate=function(h,f){Live.Controls.Template.call(this);var a=this,c=0,d=0,b=Number(h),g=Number(f)+1;this.anchors=[];this.moreActionsText="";this.actionLinksMayWrap=false;this.clear=function(){this.anchors=[];c=0;d=0};this.add=function(d,c,b){a.addNamed({text:d,link:c,clickEvent:b})};this.addNamed=function(b){var a=new Live.Controls.ActionsTemplate.Anchor;n(a,b);if(!this.actionLinksMayWrap){a.a_additionalAttributes=(!$Browser._isIE||7<=$Browser.version?' style="white-space:nowrap"':"")+(a.text?' title="'+a.text.encodeHtml()+'"':"");a.li_additionalAttributes=' class="clip"'}k(a)};function k(k){var e=a.anchors,h=e.length;while(h--)if(j(k,e[h]))return;e.push(k);if(!c&&!d&&g<=e.length){var f=new Live.Controls.ActionsTemplate.MoreActions;f.text=a.moreActionsText;f.clickEvent=i;e.splice(b,0,f);c=1}}function i(f){var e=a.anchors,g=e.length,h=e[b].getElement();if(!f)f=window.event;c=0;d=1;h.removeNode(true);e[b].dispose();while(b<--g)e[g].getElement().style.display="block";e[b+1].getElement("anchor").focus();e.splice(b,1);f.returnValue=false;f.cancelBubble=true}function j(a,b){return a.text===b.text&&a.link===b.link&&a.target===b.target&&a.clickEvent===b.clickEvent}var e=0;this.beforeToString=function(){if(e){a.unrender();e=0}};var m=this.render;this.render=function(){e=1;try{m();var f=a.anchors,d=f.length;while(d--)f[d].attachClickEventIf();if(c){d=f.length;while(b<--d)a.anchors[d].getElement().style.display="none"}}catch(g){}};var l=this.dispose;this.dispose=function(){l();a.unrender()};this.unrender=function(){var b=a.anchors,c=b.length;while(c--)b[c].detachClickEventIf()};function n(c,b){var a;for(a in b)c[a]=b[a]}};Live.Controls.ActionsTemplate.__template='<div class="uxp_ep_actions">'+'<ul class="uxp_ep_actionsList">'+"{anchors}"+"</ul>"+"</div>";Live.Controls.ActionsTemplate.Anchor=function(){Live.Controls.Template.call(this);var a=this;this.text=this.link=this.target=this.a_additionalAttributes=this.li_additionalAttributes="";this.clickEvent=null;this.dispose=function(){a.detachClickEventIf()};this.attachClickEventIf=function(){var b=a.getElement("anchor");if(b&&a.clickEvent)b.attachEvent("onclick",a.clickEvent)};this.detachClickEventIf=function(){var b=a.getElement("anchor");if(b&&a.clickEvent)b.detachEvent("onclick",a.clickEvent)}};Live.Controls.ActionsTemplate.Anchor.__template='<li id="{id}"{li_additionalAttributes}>'+'<a id="{id}_anchor" href="{link}" target="{target}"{a_additionalAttributes}>{text}</a>'+"</li>";Live.Controls.ActionsTemplate.MoreActions=function(){Live.Controls.Template.call(this);var a=this;this.text="";this.clickEvent=null;this.imagePath=$Config.Themes.url+"controls/img/";this.dispose=function(){a.detachClickEventIf()};this.attachClickEventIf=function(){var b=a.getElement("anchor");if(b&&a.clickEvent)b.attachEvent("onclick",a.clickEvent)};this.detachClickEventIf=function(){var b=a.getElement("anchor");if(b&&a.clickEvent)b.detachEvent("onclick",a.clickEvent)}};Live.Controls.ActionsTemplate.MoreActions.__template='<li id="{id}">'+'<a id="{id}_anchor" href="#" onclick="return false">{text}<img src="{imagePath}ep_more_actions.gif" width="9" height="6" class="uxp_ep_moreActionsImage" alt="" /></a>'+"</li>";Live.Controls.UniqueElementId=function(){var a;this.toString=function(){return a||(a=Live.Controls.UniqueElementId.__prefix+Live.Controls.UniqueElementId.__count++)}};Live.Controls.UniqueElementId.__count=0;Live.Controls.UniqueElementId.__prefix="live__id"